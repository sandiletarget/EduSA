{% extends "core/base.html" %}
{% load static %}

{% block extra_head %}
    <link rel="stylesheet" href="{% static 'core/css/classroom.css' %}">
{% endblock %}

{% block body_class %}classroom-body{% endblock %}

{% block content %}
<div class="classroom-page">
    <header class="classroom-hero">
        <div>
            <span class="classroom-kicker">Classroom</span>
            <h1 class="classroom-title">{{ classroom.name }}</h1>
            <p class="classroom-subtitle">{{ classroom.description|default:"No description yet." }}</p>
        </div>
        {% if active_session %}
            <span class="status-pill is-live">Live now</span>
        {% else %}
            <span class="status-pill">Offline</span>
        {% endif %}
    </header>

    <section class="classroom-grid">
        <div class="info-card">
            <p class="label">Teacher</p>
            <p class="value">{{ classroom.teacher.get_full_name|default:classroom.teacher.username }}</p>
        </div>
        {% if is_teacher %}
            <div class="info-card">
                <p class="label">Passcode</p>
                <p class="value">{{ classroom.passcode }}</p>
            </div>
        {% endif %}
        <div class="info-card">
            <p class="label">Members</p>
            <p class="value">{{ classroom.memberships.count }}</p>
        </div>
        <div class="info-card">
            <p class="label">Status</p>
            <p class="value">{% if active_session %}Live{% else %}Offline{% endif %}</p>
        </div>
    </section>

    <section class="classroom-actions">
        {% if is_teacher %}
            <a href="{% url 'lesson_add' %}" class="btn btn-primary">Create Lesson</a>
            <a href="{% url 'classes:start_live_session' classroom.pk %}" class="btn btn-outline">Start Live Session</a>
        {% else %}
            <a href="{% url 'student_lessons' %}" class="btn btn-primary">View Lessons</a>
            <a href="{% url 'classes:join_live_session' classroom.pk %}" class="btn btn-outline">Join Live Session</a>
        {% endif %}
    </section>

    <div class="classroom-alert">
        {% if active_session %}
            Live session active since {{ active_session.started_at|date:"F j, Y g:i a" }}
        {% else %}
            No live session running currently.
        {% endif %}
    </div>

    <section class="classroom-panel">
        <div class="panel-header">
            <div>
                <p class="panel-kicker">Live Session</p>
                <h2>Class Live Room</h2>
            </div>
            {% if active_session %}
                <span class="status-pill is-live">Live</span>
            {% else %}
                <span class="status-pill">Offline</span>
            {% endif %}
        </div>

        {% if active_session %}
            <div class="panel-media">
                <div id="jitsi-meet" class="jitsi-shell"></div>
            </div>
        {% else %}
            <p class="panel-note">The teacher has not started the live session yet.</p>
        {% endif %}
    </section>

    <section class="classroom-panel">
        <div class="panel-header">
            <div>
                <p class="panel-kicker">Members</p>
                <h2>Enrolled Learners</h2>
            </div>
            <span class="status-pill">{{ classroom.memberships.count }} total</span>
        </div>
        <ul class="member-list">
            {% for membership in memberships %}
                <li>{{ membership.learner.get_full_name|default:membership.learner.username }}</li>
            {% empty %}
                <li class="is-empty">No learners have joined yet.</li>
            {% endfor %}
        </ul>
    </section>
</div>
{% if active_session %}
<script src="https://meet.jit.si/external_api.js"></script>
<script>
    (function () {
        var parentNode = document.querySelector("#jitsi-meet");
        if (!parentNode || !window.JitsiMeetExternalAPI) {
            return;
        }

        var domain = "{{ jitsi_domain|escapejs }}";
        var roomName = "{{ jitsi_room|escapejs }}";
        var displayName = "{{ jitsi_display_name|escapejs }}";
        var isTeacher = {{ is_teacher|yesno:"true,false" }};
        var startMuted = !isTeacher;

        new JitsiMeetExternalAPI(domain, {
            roomName: roomName,
            parentNode: parentNode,
            userInfo: {
                displayName: displayName,
            },
            configOverwrite: {
                prejoinPageEnabled: false,
                startWithAudioMuted: startMuted,
                startWithVideoMuted: startMuted,
                disableDeepLinking: true,
            },
            interfaceConfigOverwrite: {
                TOOLBAR_BUTTONS: [
                    "microphone",
                    "camera",
                    "desktop",
                    "fullscreen",
                    "tileview",
                    "chat",
                    "raisehand",
                    "participants-pane",
                    "hangup",
                ],
            },
        });
    })();
</script>
{% endif %}
{% endblock %}
